# Docker Compose Override for Building from Source
#
# This file enables:
#   - Building the image locally instead of pulling pre-built
#   - Hot upgrades via host-mounted plugin directories
#
# Usage:
#   cp docker-compose.build.yml docker-compose.override.yml
#   docker-compose up -d --build
#
# Hot Upgrades (after initial build):
#   ./scripts/hot-upgrade.sh
#
# Requirements:
#   - Clone cl_revenue_ops next to cl-hive:
#       git clone https://github.com/lightning-goats/cl_revenue_ops.git ../../cl_revenue_ops
#   - Optional local Archon repo (for manual install / bind mount workflows):
#       git clone https://github.com/lightning-goats/cl-hive-archon.git ../../cl-hive-archon
#   - Copy bitcoin-cli if not downloading in Dockerfile:
#       cp /usr/local/bin/bitcoin-cli ./bitcoin-cli

services:
  cln:
    # Build from source instead of using pre-built image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        CLN_VERSION: v25.12.1
        SLING_VERSION: v4.1.3
        CLN_REST_VERSION: v0.10.7
        CL_REVENUE_OPS_VERSION: v2.2.5
        CL_HIVE_COMMS_VERSION: ${CL_HIVE_COMMS_VERSION:-v0.1.0}
        CL_HIVE_ARCHON_VERSION: ${CL_HIVE_ARCHON_VERSION:-v0.1.0}
    image: cl-hive-node:local

    volumes:
      # =================================================================
      # PLUGIN MOUNTS - Enable hot upgrades via ./scripts/hot-upgrade.sh
      # These mount the git repos so updates can be pulled without rebuilding.
      # =================================================================

      # cl-hive (coordination layer)
      - ..:/opt/cl-hive:ro

      # cl-revenue-ops (execution layer)
      - ../../cl_revenue_ops:/opt/cl-revenue-ops:ro

      # Optional Phase 6 plugin repos (for local development)
      # - ../../cl-hive-comms:/opt/cl-hive-comms:ro
      # - ../../cl-hive-archon:/opt/cl-hive-archon:ro

      # bitcoin-cli mount (if not baked into image)
      - ./bitcoin-cli:/usr/local/bin/bitcoin-cli:ro
